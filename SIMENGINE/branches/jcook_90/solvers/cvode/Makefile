# Copyright 2009, 2010 Simatra Modeling Technologies, L.L.C.
# For more information, please visit http://www.simatratechnologies.com

include ../../include/common.make

# Two copies of the library are compiled: one for single precision and one for double.
# They are built within directories named `float' and `double' respectively.

DATATYPES = float double
SUNDIALS = sundials-2.4.0

SUNDIALS_URI = https://computation.llnl.gov/casc/sundials/download/code/$(SUNDIALS).tar.gz
SUNDIALS_TGZ := $(wildcard /shared/simEngine_support/$(SUNDIALS).tar.gz)
ifeq (,$(SUNDIALS_TGZ))
SUNDIALS_TGZ = /var/tmp/$(SUNDIALS).tar.gz
endif

CVODE_PATH = $(SUNDIALS)/src
CVODE_OBJS = $(CVODE_PATH)/cvode/.libs/cvode_dense.o \
	$(CVODE_PATH)/cvode/.libs/cvode_direct.o \
	$(CVODE_PATH)/cvode/.libs/cvode_io.o \
	$(CVODE_PATH)/cvode/.libs/cvode.o \
        $(CVODE_PATH)/cvode/.libs/cvode_diag.o \
        $(CVODE_PATH)/cvode/.libs/cvode_band.o \
	$(CVODE_PATH)/nvec_ser/.libs/nvector_serial.o \
	$(CVODE_PATH)/sundials/.libs/sundials_dense.o \
	$(CVODE_PATH)/sundials/.libs/sundials_direct.o \
	$(CVODE_PATH)/sundials/.libs/sundials_math.o \
	$(CVODE_PATH)/sundials/.libs/sundials_nvector.o \
	$(CVODE_PATH)/sundials/.libs/sundials_band.o \

# Not all of the following are needed, but this is a good start to trimming closer to what we do need
# Headers which appear in the original sources tgz.
BUILD_HEADERS = \
	sundials/sundials_types.h \
	sundials/sundials_math.h \
	sundials/sundials_nvector.h \
	sundials/sundials_fnvector.h \
	sundials/sundials_dense.h \
	sundials/sundials_direct.h \
	sundials/sundials_band.h \
	sundials/sundials_lapack.h \
	sundials/sundials_spgmr.h \
	sundials/sundials_spbcgs.h \
	sundials/sundials_sptfqmr.h \
	sundials/sundials_iterative.h \
	nvector/nvector_serial.h \
	nvector/nvector_parallel.h \
	cvode/cvode.h \
	cvode/cvode_direct.h \
	cvode/cvode_dense.h \
	cvode/cvode_band.h \
	cvode/cvode_lapack.h \
	cvode/cvode_diag.h \
	cvode/cvode_spgmr.h \
	cvode/cvode_spbcgs.h \
	cvode/cvode_sptfqmr.h \
	cvode/cvode_spils.h \
	cvode/cvode_bandpre.h \
	cvode/cvode_bbdpre.h

# Headers which are generated by build.
GENERATED_HEADERS = \
	sundials/sundials_config.h

CVODE_HEADERS = $(BUILD_HEADERS) $(GENERATED_HEADERS)

BUILD_DEPENDENCIES = $(SUNDIALS)/Makefile.in \
	$(SUNDIALS)/configure.ac \
	$(SUNDIALS)/acinclude.m4 \
	$(SUNDIALS)/config.hin \
	$(SUNDIALS)/configure \
	$(SUNDIALS)/config/config.guess \
	$(SUNDIALS)/config/config.sub \
	$(SUNDIALS)/config/install-sh \
	$(SUNDIALS)/config/mkinstalldirs \
	$(SUNDIALS)/config/rminstalldirs \
	$(SUNDIALS)/config/ltmain.sh \
	$(SUNDIALS)/config/mod_c.m4 \
	$(SUNDIALS)/config/mod_fortran.m4 \
	$(SUNDIALS)/config/cust_general.m4 \
	$(SUNDIALS)/config/CheckFortranFunctionExists.cmake \
	$(SUNDIALS)/config/SundialsFortran.cmake \
	$(SUNDIALS)/config/SundialsLapack.cmake \
	$(SUNDIALS)/config/SundialsMPIC.cmake \
	$(SUNDIALS)/config/SundialsMPIF.cmake \
	$(SUNDIALS)/config/FindLAPACK.cmake \
	$(SUNDIALS)/config/FindBLAS.cmake \
	$(SUNDIALS)/config/FindMPI.cmake \
	$(SUNDIALS)/bin/sundials-config.in \
	$(SUNDIALS)/bin/fortran-update.in \
	$(SUNDIALS)/bin/makefile-update.in \
	$(addprefix $(SUNDIALS)/include/,$(BUILD_HEADERS)) \
	$(SUNDIALS)/include/sundials/sundials_config.in \
	$(SUNDIALS)/src/sundials/Makefile.in \
	$(SUNDIALS)/src/sundials/CMakeLists.txt \
	$(SUNDIALS)/src/sundials/sundials_math.c \
	$(SUNDIALS)/src/sundials/sundials_nvector.c \
	$(SUNDIALS)/src/sundials/sundials_dense.c \
	$(SUNDIALS)/src/sundials/sundials_direct.c \
	$(SUNDIALS)/src/sundials/sundials_band.c \
	$(SUNDIALS)/src/sundials/sundials_spgmr.c \
	$(SUNDIALS)/src/sundials/sundials_spbcgs.c \
	$(SUNDIALS)/src/sundials/sundials_sptfqmr.c \
	$(SUNDIALS)/src/sundials/sundials_iterative.c \
	$(SUNDIALS)/src/nvec_ser/Makefile.in \
	$(SUNDIALS)/src/nvec_ser/CMakeLists.txt \
	$(SUNDIALS)/src/nvec_ser/fnvector_serial.h \
	$(SUNDIALS)/src/nvec_ser/nvector_serial.c \
	$(SUNDIALS)/src/nvec_ser/fnvector_serial.c \
	$(SUNDIALS)/src/cvode/Makefile.in \
	$(SUNDIALS)/src/cvode/CMakeLists.txt \
	$(SUNDIALS)/src/cvode/cvode.c \
	$(SUNDIALS)/src/cvode/cvode_io.c \
	$(SUNDIALS)/src/cvode/cvode_direct.c \
	$(SUNDIALS)/src/cvode/cvode_dense.c \
	$(SUNDIALS)/src/cvode/cvode_band.c \
	$(SUNDIALS)/src/cvode/cvode_lapack.c \
	$(SUNDIALS)/src/cvode/cvode_diag.c \
	$(SUNDIALS)/src/cvode/cvode_spils.c \
	$(SUNDIALS)/src/cvode/cvode_spgmr.c \
	$(SUNDIALS)/src/cvode/cvode_spbcgs.c \
	$(SUNDIALS)/src/cvode/cvode_sptfqmr.c \
	$(SUNDIALS)/src/cvode/cvode_bandpre.c \
	$(SUNDIALS)/src/cvode/cvode_bbdpre.c \
	$(SUNDIALS)/src/cvode/cvode_impl.h \
	$(SUNDIALS)/src/cvode/cvode_direct_impl.h \
	$(SUNDIALS)/src/cvode/cvode_diag_impl.h \
	$(SUNDIALS)/src/cvode/cvode_spils_impl.h \
	$(SUNDIALS)/src/cvode/cvode_bandpre_impl.h \
	$(SUNDIALS)/src/cvode/cvode_bbdpre_impl.h 

SUNDIALS_CONFIGURE_FLAGS = $(SUNDIALS_CONFIGURE_PRECISION) \
	--disable-static --enable-shared \
	--with-cflags="$(CFLAGS) $(TARGET_ARCH)" 

# Final products are installed in the parent directory.
PRODUCT_LIBS = $(addsuffix .a,$(addprefix libcvode_,$(DATATYPES)))

PRODUCT_HEADERS = $(addprefix float/,$(CVODE_HEADERS)) $(addprefix double/,$(CVODE_HEADERS))



.PHONY: all install clean

all: float double

install: all mk_install_dirs 
	$(MAKE) install_headers 
	$(MAKE) install_libs

clean:
	$(RM) libcvode_float.a libcvode_double.a
	$(RM) float double

.PHONY: install_dirs
mk_install_dirs:
	[ -d ../include/float/sundials ] || $(MKDIR) ../include/float/sundials
	[ -d ../include/float/nvector ] || $(MKDIR) ../include/float/nvector
	[ -d ../include/float/cvode ] || $(MKDIR) ../include/float/cvode
	[ -d ../include/double/sundials ] || $(MKDIR) ../include/double/sundials
	[ -d ../include/double/nvector ] || $(MKDIR) ../include/double/nvector
	[ -d ../include/double/cvode ] || $(MKDIR) ../include/double/cvode
	[ -d ../lib ] || $(MKDIR) ../lib

.PHONY: install_headers
install_headers: $(addprefix ../include/,$(PRODUCT_HEADERS))

.PHONY: install_libs
install_libs: $(addprefix ../lib/,$(PRODUCT_LIBS))

# Called from install_headers
../include/float/sundials/%.h: float/$(SUNDIALS)/include/sundials/%.h
	$(INSTALL_HEADER) $< $@
../include/float/nvector/%.h: float/$(SUNDIALS)/include/nvector/%.h
	$(INSTALL_HEADER) $< $@
../include/float/cvode/%.h: float/$(SUNDIALS)/include/cvode/%.h
	$(INSTALL_HEADER) $< $@
../include/double/sundials/%.h: double/$(SUNDIALS)/include/sundials/%.h
	$(INSTALL_HEADER) $< $@
../include/double/nvector/%.h: double/$(SUNDIALS)/include/nvector/%.h
	$(INSTALL_HEADER) $< $@
../include/double/cvode/%.h: double/$(SUNDIALS)/include/cvode/%.h
	$(INSTALL_HEADER) $< $@

# Called from install_libs
../lib/libcvode_%.a: %/libcvode.a
	$(INSTALL_PROG) $< $@

%/libcvode.a: %
	$(MAKE) -C $< -I $(CURDIR) -f $(realpath $(firstword $(MAKEFILE_LIST))) libcvode.a

libcvode.a: $(CVODE_OBJS)
	$(AR) $(ARFLAGS) $@ $?

# CVODE_OBJS
$(CVODE_PATH)/cvode/.libs/%.o: $(SUNDIALS)
$(CVODE_PATH)/nvec_ser/.libs/%.o: $(SUNDIALS)
$(CVODE_PATH)/sundials/.libs/%.o: $(SUNDIALS)

$(SUNDIALS_TGZ):
	curl -o $@ -# $(SUNDIALS_URI)

# Single-precision build within subdirectory
float: $(SUNDIALS_TGZ)
	[ -d $@ ] || $(MKDIR) $@
	$(MAKE) -C $@ -I $(CURDIR) -f $(realpath $(firstword $(MAKEFILE_LIST))) SUNDIALS_CONFIGURE_PRECISION="--with-precision=single" $(SUNDIALS)

# Double-precision build within subdirectory
double: $(SUNDIALS_TGZ)
	[ -d $@ ] || $(MKDIR) $@
	$(MAKE) -C $@ -I $(CURDIR) -f $(realpath $(firstword $(MAKEFILE_LIST))) SUNDIALS_CONFIGURE_PRECISION="--with-precision=double" $(SUNDIALS)

$(SUNDIALS): CONFIGURE_FLAGS += $(SUNDIALS_CONFIGURE_FLAGS)
$(SUNDIALS): $(SUNDIALS)/Makefile
	$(MAKE) -C $@

$(SUNDIALS)/Makefile: $(SUNDIALS_TGZ)
	tar xf $< $(BUILD_DEPENDENCIES)
	cd $(SUNDIALS); $(CONFIGURE) $(CONFIGURE_FLAGS)

